<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin - Éditeur d'utilisateurs en masse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 164, 220, 0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .config-section {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .config-section h2 {
            color: #00a4dc;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #00a4dc;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #00a4dc;
            box-shadow: 0 0 0 3px rgba(0, 164, 220, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 164, 220, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 164, 220, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #444;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary:hover {
            background: #555;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        .users-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .user-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .user-card:hover {
            border-color: #00a4dc;
            box-shadow: 0 5px 15px rgba(0, 164, 220, 0.3);
        }

        .user-card.selected {
            background: #1e3a5f;
            border-color: #00a4dc;
            box-shadow: 0 5px 20px rgba(0, 164, 220, 0.5);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .user-details h3 {
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #888;
            font-size: 14px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .setting-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .setting-card h3 {
            color: #00a4dc;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .message.success {
            background: #1e4d2b;
            border: 1px solid #2e7d3e;
            color: #4ade80;
        }

        .message.error {
            background: #4d1e1e;
            border: 1px solid #7d2e2e;
            color: #f87171;
        }

        .message.info {
            background: #1e3a5f;
            border: 1px solid #2e5a8f;
            color: #60a5fa;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00a4dc;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .select-all-wrapper {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #userCount {
            color: #00a4dc;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #2a2a2a;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #00a4dc 0%, #aa5cc3 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: #e0e0e0;
        }

        .tab.active {
            color: #00a4dc;
            border-bottom-color: #00a4dc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background: #1a1a1a;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideDown 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 30px;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #e0e0e0;
        }

        .policy-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .policy-item {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .library-item {
            padding: 10px;
            background: #333;
            border-radius: 6px;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }

        .library-item:hover {
            border-color: #00a4dc;
            background: #3a3a3a;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Jellyfin - Éditeur d'utilisateurs en masse</h1>
            <p>Gérez facilement les paramètres de plusieurs utilisateurs simultanément</p>
        </div>

        <div class="config-section">
            <h2>⚙️ Configuration de connexion</h2>
            <div class="form-group">
                <label for="serverUrl">URL du serveur Jellyfin</label>
                <input type="text" id="serverUrl" placeholder="https://jellyfin.example.com" value="">
            </div>
            <div class="form-group">
                <label for="apiKey">Clé API</label>
                <input type="password" id="apiKey" placeholder="Votre clé API" value="">
            </div>
            <button class="btn" onclick="connectToServer()">
                <span id="connectBtnText">Se connecter au serveur</span>
                <span id="connectLoader" class="loading" style="display: none;"></span>
            </button>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="config-section">
                <h2>👥 Sélection des utilisateurs</h2>
                <div class="select-all-wrapper">
                    <button class="btn btn-secondary" onclick="selectAllUsers()">Sélectionner tout</button>
                    <button class="btn btn-secondary" onclick="deselectAllUsers()">Désélectionner tout</button>
                    <span>Utilisateurs sélectionnés: <span id="userCount">0</span></span>
                </div>
                <div id="usersList" class="users-grid"></div>
            </div>

            <div class="config-section">
                <h2>🔧 Options de modification</h2>
                
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('permissions')">Permissions</button>
                    <button class="tab" onclick="switchTab('access')">Accès aux bibliothèques</button>
                    <button class="tab" onclick="switchTab('streaming')">Streaming</button>
                    <button class="tab" onclick="switchTab('sync')">Synchronisation</button>
                    <button class="tab" onclick="switchTab('features')">Fonctionnalités</button>
                </div>

                <div id="permissionsTab" class="tab-content active">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>Permissions administratives</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="isAdministrator">
                                <label for="isAdministrator">Administrateur du serveur</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="isHidden">
                                <label for="isHidden">Masquer de l'écran de connexion</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="isDisabled">
                                <label for="isDisabled">Désactiver cet utilisateur</label>
                            </div>
                        </div>

                        <div class="setting-card">
                            <h3>Gestion du contenu</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableMediaDeletion">
                                <label for="enableMediaDeletion">Autoriser la suppression de médias</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableMediaDownloading">
                                <label for="enableMediaDownloading">Autoriser le téléchargement de médias</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableContentDeletion">
                                <label for="enableContentDeletion">Autoriser la suppression de contenu</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="accessTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>Accès aux bibliothèques</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableAllLibraries" onchange="toggleLibrariesSelection()">
                                <label for="enableAllLibraries">Accès à toutes les bibliothèques</label>
                            </div>
                            <div id="librariesSelection" style="display: none; margin-top: 15px;">
                                <p style="margin-bottom: 10px; color: #888;">Sélectionnez les bibliothèques accessibles :</p>
                                <div id="librariesList" class="policy-grid"></div>
                            </div>
                            <div class="checkbox-wrapper" style="margin-top: 15px;">
                                <input type="checkbox" id="enableAllDevices">
                                <label for="enableAllDevices">Accès depuis tous les appareils</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableLiveTv">
                                <label for="enableLiveTv">Activer la TV en direct</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableLiveTvManagement">
                                <label for="enableLiveTvManagement">Gérer les enregistrements TV</label>
                            </div>
                        </div>

                        <div class="setting-card">
                            <h3>Contrôle parental</h3>
                            <div class="form-group">
                                <label for="maxParentalRating">Classification parentale maximale</label>
                                <select id="maxParentalRating">
                                    <option value="">Ne pas modifier</option>
                                    <option value="0">Non classé</option>
                                    <option value="6">6+</option>
                                    <option value="12">12+</option>
                                    <option value="16">16+</option>
                                    <option value="18">18+</option>
                                </select>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="blockUnratedItems">
                                <label for="blockUnratedItems">Bloquer les éléments non classés</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="streamingTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>Lecture multimédia</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableMediaPlayback">
                                <label for="enableMediaPlayback">Autoriser la lecture multimédia</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableAudioPlaybackTranscoding">
                                <label for="enableAudioPlaybackTranscoding">Autoriser le transcodage audio</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableVideoPlaybackTranscoding">
                                <label for="enableVideoPlaybackTranscoding">Autoriser le transcodage vidéo</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enablePlaybackRemuxing">
                                <label for="enablePlaybackRemuxing">Autoriser le remuxing vidéo</label>
                            </div>
                        </div>

                        <div class="setting-card">
                            <h3>Limites de bande passante</h3>
                            <div class="form-group">
                                <label for="remoteClientBitrateLimit">Limite de débit à distance (Mbps)</label>
                                <input type="text" id="remoteClientBitrateLimit" placeholder="0 pour illimité">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="syncTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>Synchronisation</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableSyncTranscoding">
                                <label for="enableSyncTranscoding">Autoriser le transcodage pour la synchronisation</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableSharing">
                                <label for="enableSharing">Autoriser le partage multimédia</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="featuresTab" class="tab-content">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h3>Fonctionnalités utilisateur</h3>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableUserPreferenceAccess">
                                <label for="enableUserPreferenceAccess">Autoriser la modification des préférences</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="forceRemoteSourceTranscoding">
                                <label for="forceRemoteSourceTranscoding">Forcer le transcodage des sources distantes</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="enableRemoteAccess">
                                <label for="enableRemoteAccess">Autoriser l'accès à distance</label>
                            </div>
                        </div>

                        <div class="setting-card">
                            <h3>Sécurité</h3>
                            <div class="form-group">
                                <label for="invalidLoginAttemptCount">Tentatives de connexion échouées avant verrouillage</label>
                                <input type="text" id="invalidLoginAttemptCount" placeholder="0 pour désactiver">
                            </div>
                            <div class="form-group">
                                <label for="loginAttemptsBeforeLockout">Délai de verrouillage (minutes)</label>
                                <input type="text" id="loginAttemptsBeforeLockout" placeholder="0 pour désactiver">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="applyChanges()">
                        <span id="applyBtnText">Appliquer les modifications</span>
                        <span id="applyLoader" class="loading" style="display: none;"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">Réinitialiser</button>
                    <button class="btn btn-secondary" onclick="exportSettings()">Exporter les paramètres</button>
                    <button class="btn btn-secondary" onclick="importSettings()">Importer les paramètres</button>
                </div>
            </div>
        </div>

        <div id="messageContainer"></div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Détails de l'application des modifications</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let serverUrl = '';
        let apiKey = '';
        let users = [];
        let selectedUsers = new Set();
        let currentTab = 'permissions';
        let libraries = [];

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 5000);
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        async function connectToServer() {
            const urlInput = document.getElementById('serverUrl');
            const keyInput = document.getElementById('apiKey');
            const connectBtn = document.getElementById('connectBtnText');
            const loader = document.getElementById('connectLoader');
            
            serverUrl = urlInput.value.trim();
            apiKey = keyInput.value.trim();
            
            if (!serverUrl || !apiKey) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            // Ensure URL doesn't end with /
            serverUrl = serverUrl.replace(/\/$/, '');
            
            connectBtn.style.display = 'none';
            loader.style.display = 'inline-block';
            
            try {
                // Try direct connection first
                let response;
                try {
                    response = await fetch(`${serverUrl}/Users`, {
                        headers: {
                            'X-Emby-Token': apiKey
                        }
                    });
                } catch (corsError) {
                    // If CORS error, show helpful message
                    showMessage('Erreur CORS détectée. Voir les solutions ci-dessous.', 'error');
                    showCORSSolutions();
                    throw corsError;
                }
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                users = await response.json();
                
                // Fetch libraries
                const libResponse = await fetch(`${serverUrl}/Library/MediaFolders`, {
                    headers: {
                        'X-Emby-Token': apiKey
                    }
                });
                
                if (libResponse.ok) {
                    const libData = await libResponse.json();
                    libraries = libData.Items || [];
                    updateLibrariesList();
                }
                
                displayUsers();
                document.getElementById('mainContent').style.display = 'block';
                showMessage(`Connecté avec succès! ${users.length} utilisateurs et ${libraries.length} bibliothèques trouvés.`, 'success');
                
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    showMessage(`Erreur de connexion: Impossible de joindre le serveur. Vérifiez l'URL et les paramètres CORS.`, 'error');
                } else {
                    showMessage(`Erreur de connexion: ${error.message}`, 'error');
                }
            } finally {
                connectBtn.style.display = 'inline';
                loader.style.display = 'none';
            }
        }

        function showCORSSolutions() {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h3 style="color: #f87171; margin-bottom: 20px;">⚠️ Problème de CORS détecté</h3>
                
                <div class="policy-grid">
                    <div class="policy-item">
                        <h4 style="color: #00a4dc; margin-bottom: 10px;">Solution 1: Configurer Jellyfin</h4>
                        <p>Ajoutez votre domaine dans les paramètres CORS de Jellyfin :</p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>Allez dans Dashboard → Réseau</li>
                            <li>Dans "CORS", ajoutez l'origine : <code>${window.location.origin}</code></li>
                            <li>Ou utilisez <code>*</code> pour autoriser toutes les origines (moins sécurisé)</li>
                            <li>Redémarrez Jellyfin</li>
                        </ol>
                    </div>
                    
                    <div class="policy-item">
                        <h4 style="color: #00a4dc; margin-bottom: 10px;">Solution 2: Extension navigateur</h4>
                        <p>Installez une extension pour désactiver CORS temporairement :</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Chrome: "CORS Unblock" ou "Allow CORS"</li>
                            <li>Firefox: "CORS Everywhere"</li>
                            <li>⚠️ Désactivez après utilisation pour votre sécurité</li>
                        </ul>
                    </div>
                    
                    <div class="policy-item">
                        <h4 style="color: #00a4dc; margin-bottom: 10px;">Solution 3: Héberger localement</h4>
                        <p>Sauvegardez cette page HTML et ouvrez-la directement :</p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>Clic droit → "Enregistrer sous"</li>
                            <li>Sauvegardez le fichier HTML</li>
                            <li>Ouvrez le fichier directement dans votre navigateur</li>
                            <li>Les requêtes locales ont moins de restrictions CORS</li>
                        </ol>
                    </div>
                    
                    <div class="policy-item">
                        <h4 style="color: #00a4dc; margin-bottom: 10px;">Solution 4: Serveur proxy</h4>
                        <p>Utilisez un serveur proxy local avec Node.js :</p>
                        <pre style="background: #1a1a1a; padding: 10px; margin-top: 10px; border-radius: 5px; overflow-x: auto;">
npm install -g local-cors-proxy
lcp --proxyUrl ${serverUrl} --port 8010

Puis utilisez: http://localhost:8010</pre>
                    </div>

                    <div class="policy-item">
                        <h4 style="color: #00a4dc; margin-bottom: 10px;">Solution 5: Script Python</h4>
                        <p>Créez un script Python pour gérer les utilisateurs :</p>
                        <button class="btn btn-secondary" onclick="downloadPythonScript()">
                            Télécharger le script Python
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #1e3a5f; border-radius: 8px;">
                    <p><strong>💡 Conseil :</strong> La solution 1 (configurer Jellyfin) est la plus propre et permanente. 
                    La solution 3 (héberger localement) est la plus rapide pour un usage ponctuel.</p>
                </div>
            `;
            
            document.getElementById('detailsModal').style.display = 'block';
        }

        function displayUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.onclick = () => toggleUserSelection(user.Id);
                
                const initial = user.Name ? user.Name.charAt(0).toUpperCase() : '?';
                
                userCard.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${initial}</div>
                        <div class="user-details">
                            <h3>${user.Name || 'Sans nom'}</h3>
                            <p>${user.Policy?.IsAdministrator ? '👑 Administrateur' : '👤 Utilisateur'}</p>
                        </div>
                    </div>
                `;
                
                userCard.id = `user-${user.Id}`;
                usersList.appendChild(userCard);
            });
        }

        function toggleLibrariesSelection() {
            const allLibrariesCheckbox = document.getElementById('enableAllLibraries');
            const librariesSelection = document.getElementById('librariesSelection');
            
            if (allLibrariesCheckbox.checked) {
                librariesSelection.style.display = 'none';
                // Uncheck all library checkboxes
                document.querySelectorAll('.library-checkbox').forEach(cb => {
                    cb.checked = false;
                });
            } else {
                librariesSelection.style.display = 'block';
            }
        }

        function updateLibrariesList() {
            const librariesList = document.getElementById('librariesList');
            librariesList.innerHTML = '';
            
            libraries.forEach(library => {
                const libraryItem = document.createElement('div');
                libraryItem.className = 'policy-item';
                libraryItem.style.padding = '10px';
                
                const icon = getLibraryIcon(library.CollectionType);
                
                libraryItem.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="library-checkbox" id="library-${library.Id}" value="${library.Id}">
                        <label for="library-${library.Id}" style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${icon}</span>
                            <span>${library.Name}</span>
                            <span style="color: #888; font-size: 12px;">(${library.CollectionType || 'Mixte'})</span>
                        </label>
                    </div>
                `;
                
                librariesList.appendChild(libraryItem);
            });
        }

        function getLibraryIcon(collectionType) {
            const icons = {
                'movies': '🎬',
                'tvshows': '📺',
                'music': '🎵',
                'books': '📚',
                'photos': '📷',
                'musicvideos': '🎸',
                'homevideos': '🎥',
                'boxsets': '📦',
                'playlists': '📝',
                'livetv': '📡'
            };
            return icons[collectionType?.toLowerCase()] || '📁';
        }

        function toggleUserSelection(userId) {
            const userCard = document.getElementById(`user-${userId}`);
            
            if (selectedUsers.has(userId)) {
                selectedUsers.delete(userId);
                userCard.classList.remove('selected');
            } else {
                selectedUsers.add(userId);
                userCard.classList.add('selected');
            }
            
            updateUserCount();
        }

        function updateUserCount() {
            document.getElementById('userCount').textContent = selectedUsers.size;
        }

        function selectAllUsers() {
            users.forEach(user => {
                selectedUsers.add(user.Id);
                document.getElementById(`user-${user.Id}`).classList.add('selected');
            });
            updateUserCount();
        }

        function deselectAllUsers() {
            selectedUsers.clear();
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateUserCount();
        }

        function getSelectedLibraries() {
            const selectedLibraries = [];
            document.querySelectorAll('.library-checkbox:checked').forEach(checkbox => {
                selectedLibraries.push(checkbox.value);
            });
            return selectedLibraries;
        }

        function getFormValues() {
            const values = {};
            
            // Permissions
            const isAdmin = document.getElementById('isAdministrator').checked;
            const isHidden = document.getElementById('isHidden').checked;
            const isDisabled = document.getElementById('isDisabled').checked;
            
            // Build policy object based on checkboxes
            const policy = {};
            
            // Administrative permissions
            if (document.getElementById('isAdministrator').checked) {
                policy.IsAdministrator = true;
            }
            if (document.getElementById('isHidden').checked) {
                policy.IsHidden = true;
            }
            if (document.getElementById('isDisabled').checked) {
                policy.IsDisabled = true;
            }
            
            // Content management
            if (document.getElementById('enableMediaDeletion').checked) {
                policy.EnableContentDeletion = true;
            }
            if (document.getElementById('enableMediaDownloading').checked) {
                policy.EnableContentDownloading = true;
            }
            if (document.getElementById('enableContentDeletion').checked) {
                policy.EnableContentDeletion = true;
            }
            
            // Library access
            if (document.getElementById('enableAllLibraries').checked) {
                policy.EnableAllFolders = true;
                policy.EnabledFolders = [];
            } else {
                policy.EnableAllFolders = false;
                const selectedLibraries = getSelectedLibraries();
                if (selectedLibraries.length > 0) {
                    policy.EnabledFolders = selectedLibraries;
                }
            }
            if (document.getElementById('enableAllDevices').checked) {
                policy.EnableAllDevices = true;
            }
            if (document.getElementById('enableLiveTv').checked) {
                policy.EnableLiveTvAccess = true;
            }
            if (document.getElementById('enableLiveTvManagement').checked) {
                policy.EnableLiveTvManagement = true;
            }
            
            // Parental controls
            const maxRating = document.getElementById('maxParentalRating').value;
            if (maxRating) {
                policy.MaxParentalRating = parseInt(maxRating);
            }
            if (document.getElementById('blockUnratedItems').checked) {
                policy.BlockUnratedItems = {
                    Movie: true,
                    Series: true,
                    Book: true,
                    Music: true,
                    Game: true,
                    Other: true
                };
            }
            
            // Media playback
            if (document.getElementById('enableMediaPlayback').checked) {
                policy.EnableMediaPlayback = true;
            }
            if (document.getElementById('enableAudioPlaybackTranscoding').checked) {
                policy.EnableAudioPlaybackTranscoding = true;
            }
            if (document.getElementById('enableVideoPlaybackTranscoding').checked) {
                policy.EnableVideoPlaybackTranscoding = true;
            }
            if (document.getElementById('enablePlaybackRemuxing').checked) {
                policy.EnablePlaybackRemuxing = true;
            }
            
            // Bandwidth limits
            const bitrateLimit = document.getElementById('remoteClientBitrateLimit').value;
            if (bitrateLimit) {
                policy.RemoteClientBitrateLimit = parseInt(bitrateLimit) * 1000000; // Convert Mbps to bps
            }
            
            // Sync features
            if (document.getElementById('enableSyncTranscoding').checked) {
                policy.EnableSyncTranscoding = true;
            }
            if (document.getElementById('enableSharing').checked) {
                policy.EnablePublicSharing = true;
            }
            
            // User features
            if (document.getElementById('enableUserPreferenceAccess').checked) {
                policy.EnableUserPreferenceAccess = true;
            }
            if (document.getElementById('forceRemoteSourceTranscoding').checked) {
                policy.ForceRemoteSourceTranscoding = true;
            }
            if (document.getElementById('enableRemoteAccess').checked) {
                policy.EnableRemoteAccess = true;
            }
            
            // Security
            const invalidLoginCount = document.getElementById('invalidLoginAttemptCount').value;
            if (invalidLoginCount) {
                policy.InvalidLoginAttemptCount = parseInt(invalidLoginCount);
            }
            const lockoutMinutes = document.getElementById('loginAttemptsBeforeLockout').value;
            if (lockoutMinutes) {
                policy.LoginAttemptsBeforeLockout = parseInt(lockoutMinutes);
            }
            
            return { policy };
        }

        async function applyChanges() {
            if (selectedUsers.size === 0) {
                showMessage('Aucun utilisateur sélectionné', 'error');
                return;
            }
            
            const applyBtn = document.getElementById('applyBtnText');
            const loader = document.getElementById('applyLoader');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            applyBtn.style.display = 'none';
            loader.style.display = 'inline-block';
            progressBar.style.display = 'block';
            
            const formData = getFormValues();
            const results = [];
            let processed = 0;
            
            for (const userId of selectedUsers) {
                const user = users.find(u => u.Id === userId);
                
                try {
                    // First, get the current user policy
                    const userResponse = await fetch(`${serverUrl}/Users/${userId}`, {
                        headers: {
                            'X-Emby-Token': apiKey
                        }
                    });
                    
                    if (!userResponse.ok) {
                        throw new Error(`Failed to get user data: ${userResponse.status}`);
                    }
                    
                    const userData = await userResponse.json();
                    const currentPolicy = userData.Policy || {};
                    
                    // Merge current policy with new changes
                    const updatedPolicy = { ...currentPolicy };
                    
                    // Apply only the changes that were explicitly set
                    Object.keys(formData.policy).forEach(key => {
                        updatedPolicy[key] = formData.policy[key];
                    });
                    
                    // Update user policy
                    const response = await fetch(`${serverUrl}/Users/${userId}/Policy`, {
                        method: 'POST',
                        headers: {
                            'X-Emby-Token': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedPolicy)
                    });
                    
                    if (response.ok || response.status === 204) {
                        results.push({
                            user: user.Name,
                            status: 'success',
                            message: 'Modifications appliquées avec succès'
                        });
                    } else {
                        const errorText = await response.text();
                        results.push({
                            user: user.Name,
                            status: 'error',
                            message: `Erreur HTTP: ${response.status} - ${errorText}`
                        });
                    }
                } catch (error) {
                    results.push({
                        user: user.Name,
                        status: 'error',
                        message: error.message
                    });
                }
                
                processed++;
                const progress = Math.round((processed / selectedUsers.size) * 100);
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${progress}%`;
            }
            
            applyBtn.style.display = 'inline';
            loader.style.display = 'none';
            
            // Show results
            showResults(results);
            
            // Hide progress bar after animation
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                progressFill.textContent = '0%';
            }, 1000);
        }

        function showResults(results) {
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            
            if (successCount > 0) {
                showMessage(`✅ ${successCount} utilisateur(s) modifié(s) avec succès`, 'success');
            }
            if (errorCount > 0) {
                showMessage(`❌ ${errorCount} erreur(s) lors de la modification`, 'error');
            }
            
            // Show detailed results in modal
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="policy-grid">
                    ${results.map(result => `
                        <div class="policy-item">
                            <strong>${result.user}</strong>: 
                            <span style="color: ${result.status === 'success' ? '#4ade80' : '#f87171'}">
                                ${result.message}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function resetForm() {
            // Reset all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset all text inputs
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.value = '';
            });
            
            // Reset select
            document.getElementById('maxParentalRating').value = '';
            
            showMessage('Formulaire réinitialisé', 'info');
        }

        function exportSettings() {
            const settings = getFormValues();
            const dataStr = JSON.stringify(settings, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `jellyfin-user-settings-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('Paramètres exportés avec succès', 'success');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const settings = JSON.parse(text);
                    
                    // Apply settings to form
                    if (settings.policy) {
                        const policy = settings.policy;
                        
                        // Administrative permissions
                        if (policy.IsAdministrator !== undefined) {
                            document.getElementById('isAdministrator').checked = policy.IsAdministrator;
                        }
                        if (policy.IsHidden !== undefined) {
                            document.getElementById('isHidden').checked = policy.IsHidden;
                        }
                        if (policy.IsDisabled !== undefined) {
                            document.getElementById('isDisabled').checked = policy.IsDisabled;
                        }
                        
                        // Content management
                        if (policy.EnableContentDeletion !== undefined) {
                            document.getElementById('enableMediaDeletion').checked = policy.EnableContentDeletion;
                            document.getElementById('enableContentDeletion').checked = policy.EnableContentDeletion;
                        }
                        if (policy.EnableContentDownloading !== undefined) {
                            document.getElementById('enableMediaDownloading').checked = policy.EnableContentDownloading;
                        }
                        
                        // Library access
                        if (policy.EnableAllFolders !== undefined) {
                            document.getElementById('enableAllLibraries').checked = policy.EnableAllFolders;
                            toggleLibrariesSelection();
                            
                            if (!policy.EnableAllFolders && policy.EnabledFolders) {
                                policy.EnabledFolders.forEach(folderId => {
                                    const checkbox = document.getElementById(`library-${folderId}`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                        }
                        if (policy.EnableAllDevices !== undefined) {
                            document.getElementById('enableAllDevices').checked = policy.EnableAllDevices;
                        }
                        if (policy.EnableLiveTvAccess !== undefined) {
                            document.getElementById('enableLiveTv').checked = policy.EnableLiveTvAccess;
                        }
                        if (policy.EnableLiveTvManagement !== undefined) {
                            document.getElementById('enableLiveTvManagement').checked = policy.EnableLiveTvManagement;
                        }
                        
                        // Parental controls
                        if (policy.MaxParentalRating !== undefined) {
                            document.getElementById('maxParentalRating').value = policy.MaxParentalRating.toString();
                        }
                        if (policy.BlockUnratedItems !== undefined) {
                            document.getElementById('blockUnratedItems').checked = true;
                        }
                        
                        // Media playback
                        if (policy.EnableMediaPlayback !== undefined) {
                            document.getElementById('enableMediaPlayback').checked = policy.EnableMediaPlayback;
                        }
                        if (policy.EnableAudioPlaybackTranscoding !== undefined) {
                            document.getElementById('enableAudioPlaybackTranscoding').checked = policy.EnableAudioPlaybackTranscoding;
                        }
                        if (policy.EnableVideoPlaybackTranscoding !== undefined) {
                            document.getElementById('enableVideoPlaybackTranscoding').checked = policy.EnableVideoPlaybackTranscoding;
                        }
                        if (policy.EnablePlaybackRemuxing !== undefined) {
                            document.getElementById('enablePlaybackRemuxing').checked = policy.EnablePlaybackRemuxing;
                        }
                        
                        // Bandwidth limits
                        if (policy.RemoteClientBitrateLimit !== undefined) {
                            document.getElementById('remoteClientBitrateLimit').value = (policy.RemoteClientBitrateLimit / 1000000).toString();
                        }
                        
                        // Sync features
                        if (policy.EnableSyncTranscoding !== undefined) {
                            document.getElementById('enableSyncTranscoding').checked = policy.EnableSyncTranscoding;
                        }
                        if (policy.EnablePublicSharing !== undefined) {
                            document.getElementById('enableSharing').checked = policy.EnablePublicSharing;
                        }
                        
                        // User features
                        if (policy.EnableUserPreferenceAccess !== undefined) {
                            document.getElementById('enableUserPreferenceAccess').checked = policy.EnableUserPreferenceAccess;
                        }
                        if (policy.ForceRemoteSourceTranscoding !== undefined) {
                            document.getElementById('forceRemoteSourceTranscoding').checked = policy.ForceRemoteSourceTranscoding;
                        }
                        if (policy.EnableRemoteAccess !== undefined) {
                            document.getElementById('enableRemoteAccess').checked = policy.EnableRemoteAccess;
                        }
                        
                        // Security
                        if (policy.InvalidLoginAttemptCount !== undefined) {
                            document.getElementById('invalidLoginAttemptCount').value = policy.InvalidLoginAttemptCount.toString();
                        }
                        if (policy.LoginAttemptsBeforeLockout !== undefined) {
                            document.getElementById('loginAttemptsBeforeLockout').value = policy.LoginAttemptsBeforeLockout.toString();
                        }
                    }
                    
                    showMessage('Paramètres importés avec succès', 'success');
                } catch (error) {
                    showMessage(`Erreur lors de l'import: ${error.message}`, 'error');
                }
            };
            
            input.click();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved credentials
            const savedUrl = localStorage.getItem('jellyfin_server_url');
            const savedApiKey = localStorage.getItem('jellyfin_api_key');
            
            if (savedUrl) {
                document.getElementById('serverUrl').value = savedUrl;
            }
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        });

        // Save credentials when connecting
        const originalConnect = connectToServer;
        connectToServer = async function() {
            const result = await originalConnect();
            if (serverUrl && apiKey) {
                localStorage.setItem('jellyfin_server_url', serverUrl);
                localStorage.setItem('jellyfin_api_key', apiKey);
            }
            return result;
        };

        function downloadPythonScript() {
            const pythonScript = `#!/usr/bin/env python3
"""
Jellyfin Bulk User Editor - Script Python
Permet d'éditer massivement les paramètres utilisateurs Jellyfin
"""

import requests
import json
import sys
from typing import Dict, List, Any

class JellyfinBulkEditor:
    def __init__(self, server_url: str, api_key: str):
        self.server_url = server_url.rstrip('/')
        self.api_key = api_key
        self.headers = {
            'X-Emby-Token': api_key,
            'Content-Type': 'application/json'
        }
    
    def get_users(self) -> List[Dict[str, Any]]:
        """Récupère la liste des utilisateurs"""
        try:
            response = requests.get(f"{self.server_url}/Users", headers=self.headers)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Erreur lors de la récupération des utilisateurs: {e}")
            return []
    
    def update_user_policy(self, user_id: str, policy: Dict[str, Any]) -> bool:
        """Met à jour la politique d'un utilisateur"""
        try:
            response = requests.post(
                f"{self.server_url}/Users/{user_id}/Policy",
                headers=self.headers,
                json=policy
            )
            response.raise_for_status()
            return True
        except requests.exceptions.RequestException as e:
            print(f"Erreur lors de la mise à jour de l'utilisateur {user_id}: {e}")
            return False
    
    def bulk_update(self, user_ids: List[str], policy: Dict[str, Any]):
        """Met à jour plusieurs utilisateurs"""
        success_count = 0
        error_count = 0
        
        for user_id in user_ids:
            if self.update_user_policy(user_id, policy):
                success_count += 1
                print(f"✓ Utilisateur {user_id} mis à jour")
            else:
                error_count += 1
                print(f"✗ Échec pour l'utilisateur {user_id}")
        
        print(f"\\nRésumé: {success_count} succès, {error_count} erreurs")

def main():
    # Configuration
    SERVER_URL = "${serverUrl || 'https://jellyfin.example.com'}"
    API_KEY = "${apiKey || 'votre_cle_api'}"
    
    # Initialisation
    editor = JellyfinBulkEditor(SERVER_URL, API_KEY)
    
    # Récupération des utilisateurs
    users = editor.get_users()
    if not users:
        print("Aucun utilisateur trouvé")
        return
    
    print(f"Trouvé {len(users)} utilisateurs:")
    for i, user in enumerate(users):
        print(f"{i+1}. {user['Name']} (ID: {user['Id']})")
    
    # Exemple de politique à appliquer
    policy = {
        "EnableMediaPlayback": True,
        "EnableAudioPlaybackTranscoding": True,
        "EnableVideoPlaybackTranscoding": True,
        "EnablePlaybackRemuxing": True,
        "EnableContentDeletion": False,
        "EnableContentDownloading": True,
        "EnableSyncTranscoding": True,
        "EnableMediaConversion": True,
        "EnableAllDevices": True,
        "EnableAllChannels": True,
        "EnableAllFolders": True,
        "EnableRemoteAccess": True,
        "EnableLiveTvManagement": False,
        "EnableLiveTvAccess": True,
        "EnableSharing": True,
        "RemoteClientBitrateLimit": 0
    }
    
    # Sélection des utilisateurs à modifier
    print("\\nEntrez les numéros des utilisateurs à modifier (séparés par des virgules):")
    print("Exemple: 1,3,5 ou 'all' pour tous")
    selection = input("> ").strip()
    
    if selection.lower() == 'all':
        user_ids = [user['Id'] for user in users]
    else:
        try:
            indices = [int(x.strip()) - 1 for x in selection.split(',')]
            user_ids = [users[i]['Id'] for i in indices if 0 <= i < len(users)]
        except (ValueError, IndexError):
            print("Sélection invalide")
            return
    
    # Confirmation
    print(f"\\nVous allez modifier {len(user_ids)} utilisateur(s).")
    print("Continuer? (o/n)")
    if input("> ").lower() != 'o':
        print("Annulé")
        return
    
    # Application des modifications
    editor.bulk_update(user_ids, policy)

if __name__ == "__main__":
    main()
`;
            
            const blob = new Blob([pythonScript], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jellyfin_bulk_editor.py';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('Script Python téléchargé! Installez requests avec: pip install requests', 'success');
        }
    </script>
</body>
</html>
            